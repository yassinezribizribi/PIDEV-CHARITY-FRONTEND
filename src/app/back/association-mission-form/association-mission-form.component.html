<app-admin-navbar></app-admin-navbar>

<!-- Hero Start -->
<section class="bg-half-170 d-table w-100" style="background: url('assets/images/hero/pages.jpg') center;">
    <div class="bg-overlay bg-gradient-overlay"></div>
    <div class="container">
        <div class="row mt-5 justify-content-center">
            <div class="col-12">
                <div class="title-heading text-center">
                    <h5 class="heading fw-semibold mb-0 sub-heading text-white title-dark">Créer une Mission</h5>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card border-0 rounded shadow">
                    <div class="card-body">
                        <form (ngSubmit)="onSubmit()" #missionForm="ngForm">
                            <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

                            <div class="row">
                                <!-- New Title Field -->
                                <div class="col-12 mb-4">
                                    <label class="form-label fw-bold">Titre de la mission <span class="text-danger">*</span></label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        [(ngModel)]="mission.title" 
                                        name="title" 
                                        placeholder="Titre de la mission"
                                        required
                                        minlength="3"
                                        #title="ngModel">
                                    <div *ngIf="title.invalid && title.touched" class="text-danger">
                                        Le titre est requis et doit comporter au moins 3 caractères.
                                    </div>
                                </div>

                                <div class="col-12 mb-4">
                                    <label class="form-label fw-bold">Description de la mission <span class="text-danger">*</span></label>
                                    <textarea 
                                        class="form-control" 
                                        [(ngModel)]="mission.description" 
                                        name="description" 
                                        rows="4" 
                                        placeholder="Décrivez la mission en détail"
                                        required
                                        minlength="3"
                                        #description="ngModel">
                                    </textarea>
                                    <div *ngIf="description.invalid && description.touched" class="text-danger">
                                        La description est requise et doit comporter au moins 3 caractères.
                                    </div>
                                </div>

                                <div class="col-12 mb-4">
                                    <label class="form-label fw-bold">Localisation <span class="text-danger">*</span></label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        [(ngModel)]="mission.location" 
                                        name="location" 
                                        placeholder="Adresse de la mission"
                                        required
                                        minlength="3"
                                        #location="ngModel">
                                    <div *ngIf="location.invalid && location.touched" class="text-danger">
                                        La localisation est requise et doit comporter au moins 3 caractères.
                                    </div>
                                </div>

                                <!-- New Crisis ID Field -->
                                <div class="col-12 mb-4">
                                    <label class="form-label fw-bold">ID de la crise (optionnel)</label>
                                    <input 
                                        type="number" 
                                        class="form-control" 
                                        [(ngModel)]="mission.crisisId" 
                                        name="crisisId" 
                                        placeholder="ID de la crise associée">
                                </div>

                                <div class="col-md-6 mb-4">
                                    <label class="form-label fw-bold">Date de début <span class="text-danger">*</span></label>
                                    <input 
                                        type="date" 
                                        class="form-control" 
                                        [(ngModel)]="mission.startDate" 
                                        name="startDate" 
                                        required
                                        #startDate="ngModel">
                                    <div *ngIf="startDate.invalid && startDate.touched" class="text-danger">La date de début est requise.</div>
                                </div>

                                <div class="col-md-6 mb-4">
                                    <label class="form-label fw-bold">Date de fin <span class="text-danger">*</span></label>
                                    <input 
                                        type="date" 
                                        class="form-control" 
                                        [(ngModel)]="mission.endDate" 
                                        name="endDate" 
                                        required
                                        #endDate="ngModel">
                                    <div *ngIf="endDate.invalid && endDate.touched" class="text-danger">La date de fin est requise.</div>
                                    <div *ngIf="endDate.value && mission.startDate && endDate.value < mission.startDate" class="text-danger">
                                        La date de fin doit être après la date de début.
                                    </div>
                                </div>

                                <!-- Mission Logo Section -->
                                <div class="col-12 mb-4">
                                    <label class="form-label fw-bold">Logo de la mission (optionnel)</label>
                                    <input 
                                        type="file" 
                                        class="form-control" 
                                        (change)="onLogoChange($event)"
                                        accept="image/*">
                                    <small class="text-muted">Format accepté: JPG, PNG. Taille maximale: 2MB</small>
                                </div>

                                <!-- Mission Roles Section -->
                                <div class="col-12 mb-4">
                                    <label class="form-label fw-bold">Rôles de mission</label>
                                    <div class="card mb-3" *ngFor="let role of mission.missionRoles; let i = index">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <strong>Nom du rôle:</strong> {{role.roleName}}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Nombre requis:</strong> {{role.numberNeeded}}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Validation requise:</strong> {{role.requiresValidation ? 'Oui' : 'Non'}}
                                                </div>
                                                <div class="col-md-2 text-end">
                                                    <button type="button" class="btn btn-sm btn-danger" (click)="removeRole(i)">Supprimer</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">Ajouter un nouveau rôle</h6>
                                            <div class="row g-3">
                                                <div class="col-md-5">
                                                    <input type="text" class="form-control" [(ngModel)]="newRole.roleName" name="newRoleName" placeholder="Nom du rôle">
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control" [(ngModel)]="newRole.numberNeeded" name="newNumberNeeded" min="1" placeholder="Nombre requis">
                                                </div>
                                                <div class="col-md-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" [(ngModel)]="newRole.requiresValidation" name="newRequiresValidation">
                                                        <label class="form-check-label">Validation requise</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-primary" (click)="addRole()">Ajouter</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                        <button 
                                            type="button" 
                                            class="btn btn-light me-md-2" 
                                            (click)="onCancel()">
                                            Annuler
                                        </button>
                                        <button 
                                            type="submit" 
                                            class="btn btn-primary" 
                                            [disabled]="!missionForm.form.valid || submitted">
                                            {{ submitted ? 'Création en cours...' : 'Créer la mission' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>