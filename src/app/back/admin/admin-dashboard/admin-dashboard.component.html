<app-admin-navbar></app-admin-navbar>

<section class="bg-half-170 d-table w-100" style="background: url('assets/images/hero/pages.jpg') center;">
  <div class="bg-overlay bg-gradient-overlay"></div>
  <div class="container">
    <div class="row mt-5 justify-content-center">
      <div class="col-12">
        <div class="title-heading text-center">
          <h5 class="heading fw-semibold mb-0 sub-heading text-white title-dark">Admin Dashboard</h5>
        </div>
      </div>
    </div>
    <div class="position-middle-bottom">
      <nav aria-label="breadcrumb" class="d-block">
        <ul class="breadcrumb breadcrumb-muted mb-0 p-0">
          <li class="breadcrumb-item"><a [routerLink]="'/'">Solidarity</a></li>
          <li class="breadcrumb-item active" aria-current="page">Admin Dashboard</li>
        </ul>
      </nav>
    </div>
  </div>
</section>

<div class="position-relative">
  <div class="shape overflow-hidden text-white">
    <svg viewBox="0 0 2880 48" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 48H1437.5H2880V0H2160C1442.5 52 720 0 720 0H0V48Z" fill="currentColor"></path>
    </svg>
  </div>
</div>

<section class="section">
  <div class="container">
    <!-- Summary Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card card-body bg-primary bg-gradient text-white shadow-sm border-0">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">Total Crises</h6>
              <h3 class="mb-0">{{ crises.length }}</h3>
            </div>
            <i class="bi bi-exclamation-triangle-fill fs-3"></i>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-body bg-warning bg-gradient text-dark shadow-sm border-0">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-dark-50 mb-1">Pending</h6>
              <h3 class="mb-0">{{ getCrisisCountByStatus(CrisisStatus.PENDING) }}</h3>
            </div>
            <i class="bi bi-hourglass-split fs-3"></i>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-body bg-info bg-gradient text-white shadow-sm border-0">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">In Progress</h6>
              <h3 class="mb-0">{{ getCrisisCountByStatus(CrisisStatus.IN_PROGRESS) }}</h3>
            </div>
            <i class="bi bi-gear-wide-connected fs-3"></i>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-body bg-success bg-gradient text-white shadow-sm border-0">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white-50 mb-1">Resolved</h6>
              <h3 class="mb-0">{{ getCrisisCountByStatus(CrisisStatus.RESOLVED) }}</h3>
            </div>
            <i class="bi bi-check-circle-fill fs-3"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <!-- Crises Section -->
        <div class="card shadow border-0 mb-4">
          <div class="card-header bg-white d-flex justify-content-between align-items-center p-4">
            <h5 class="card-title mb-0">Crisis Management</h5>
            <div class="d-flex">
              <input type="text" class="form-control me-2" placeholder="Search crises..." [(ngModel)]="searchCrisisTerm" (input)="filterCrises()">
              <button class="btn btn-primary btn-sm" (click)="exportCrisesToCSV()">
                <i class="bi bi-download me-1"></i> Export
              </button>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Category</th>
                    <th>Location</th>
                    <th>Description</th>
                    <th>Date</th>
                    <th>Image</th>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let crisis of filteredCrises">
                    <td>
                      <span class="badge bg-light text-dark">
                        <i class="bi me-1" [ngClass]="getCategoryIcon(crisis.categorie)"></i>
                        {{ crisis.categorie || 'N/A' }}
                      </span>
                    </td>
                    <td>
                      <i class="bi bi-geo-alt me-1"></i>
                      {{ crisis.location || 'N/A' }}
                    </td>
                    <td class="text-truncate" style="max-width: 200px;" [title]="crisis.description">
                      {{ crisis.description || 'N/A' }}
                    </td>
                    <td>
                      <i class="bi bi-calendar3 me-1"></i>
                      {{ crisis.crisisDate ? (crisis.crisisDate | date:'longDate') : 'N/A' }}
                    </td>
                    <td>
                      <img *ngIf="crisis.image; else anonymousAvatar" 
     [src]="'data:image/jpeg;base64,' + crisis.image" 
     alt="Crisis Image" 
     class="img-fluid " 
     style="width: 200px; height: 100px; object-fit: cover;">

     <ng-template #anonymousAvatar>
      <mat-icon class=" d-flex align-items-center justify-content-center" 
                style="width: 200px; height: 100px; background-color: #eee; color: #777;">
                broken_image
      </mat-icon>
    </ng-template>
                    </td>
                    <td>
                      <span [ngClass]="getSeverityClass(crisis.severity)">
                        <i class="bi me-1" [ngClass]="getSeverityIcon(crisis.severity)"></i>
                        {{ crisis.severity || 'N/A' }}
                      </span>
                    </td>
                    <td>
                      <span [ngClass]="getStatusClass(crisis.status)">
                        <i class="bi me-1" [ngClass]="getStatusIcon(crisis.status)"></i>
                        {{ crisis.status || 'N/A' }}
                      </span>
                    </td>
                    <td>
                      <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" (click)="viewDetails(crisis)" title="View Details">
                          <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" (click)="updateCrisis(crisis)" title="Edit">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" (click)="deleteCrisis(crisis.idCrisis)" title="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm" 
                                [ngClass]="{
                                  'btn-outline-success': crisis.status !== CrisisStatus.RESOLVED,
                                  'btn-outline-secondary': crisis.status === CrisisStatus.RESOLVED
                                }"
                                (click)="updateStatus(crisis)" 
                                [title]="crisis.status === CrisisStatus.RESOLVED ? 'Mark as Pending' : 
                                         (crisis.status === CrisisStatus.PENDING ? 'Mark as In Progress' : 'Mark as Resolved')">
                          <i class="bi" [ngClass]="{
                            'bi-arrow-up': crisis.status === CrisisStatus.PENDING,
                            'bi-check-lg': crisis.status === CrisisStatus.IN_PROGRESS,
                            'bi-arrow-counterclockwise': crisis.status === CrisisStatus.RESOLVED
                          }"></i>
                        </button>
                      <button class="btn btn-sm btn-outline-success" (click)="(crisis)" title="Assign to Association">
                        <i class="bi bi-person-plus"></i> Assign
                      </button>
                      </div>
                    </td>
                  </tr>
                  <tr *ngIf="filteredCrises.length === 0">
                    <td colspan="7" class="text-center py-4">No crises found</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <div class="text-muted">
              Showing {{ filteredCrises.length }} of {{ crises.length }} crises
            </div>
            <nav>
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item"><a class="page-link" href="#">Previous</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">Next</a></li>
              </ul>
            </nav>
          </div>
        </div>

        <!-- Requests Section -->
        <div class="card shadow border-0">
          <div class="card-header bg-white d-flex justify-content-between align-items-center p-4">
            <h5 class="card-title mb-0">Requests Management</h5>
            <input type="text" class="form-control" style="max-width: 300px;" placeholder="Search requests..." [(ngModel)]="searchRequestTerm" (input)="filterRequests()">
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Object</th>
                    <th>Content</th>
                    <th>Urgency</th>
                    <th>Responses</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let request of filteredRequests">
                    <td class="fw-semibold">{{ request.object }}</td>
                    <td class="text-truncate" style="max-width: 200px;" [title]="request.content">
                      {{ request.content }}
                    </td>
                    <td>
                      <span class="badge" [ngClass]="request.isUrgent ? 'bg-danger' : 'bg-secondary'">
                        {{ request.isUrgent ? 'Urgent' : 'Normal' }}
                      </span>
                    </td>
                    <td>
                      <span class="badge bg-info rounded-pill">
                        {{ request.responses?.length || 0 }}
                      </span>
                    </td>
                    <td>
                      <i class="bi bi-calendar3 me-1"></i>
                      {{ request.dateRequest | date:'short' }}
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" (click)="viewRequestDetails(request)">
                        <i class="bi bi-chat-left-text"></i> Respond
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="filteredRequests.length === 0">
                    <td colspan="6" class="text-center py-4">No requests found</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <div class="text-muted">
              Showing {{ filteredRequests.length }} of {{ requests.length }} requests
            </div>
            <nav>
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item"><a class="page-link" href="#">Previous</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">Next</a></li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>