<app-admin-navbar />

<div class="dashboard-container">
  <!-- Overview Section -->
  <div class="container-fluid px-4 py-4">
    <div class="row g-4">
      <!-- Quick Stats -->
      <div class="col-xl-3 col-md-6">
        <div class="stat-card bg-primary bg-opacity-10 rounded-4 p-4 h-100">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-primary text-white rounded-circle p-3 me-3">
              <i class="bi bi-building fs-4"></i>
            </div>
            <div>
              <h6 class="text-muted mb-1">Total Associations</h6>
              <h3 class="mb-0">{{associations.length}}</h3>
            </div>
          </div>
          <div class="mt-3">
            <span class="badge bg-success-subtle text-success">
              <i class="bi bi-arrow-up me-1"></i>12% this month
            </span>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6">
        <div class="stat-card bg-warning bg-opacity-10 rounded-4 p-4 h-100">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-warning text-white rounded-circle p-3 me-3">
              <i class="bi bi-exclamation-triangle fs-4"></i>
            </div>
            <div>
              <h6 class="text-muted mb-1">Active Crises</h6>
              <h3 class="mb-0">{{crises.length}}</h3>
            </div>
          </div>
          <div class="mt-3">
            <span class="badge bg-danger-subtle text-danger">
              <i class="bi bi-arrow-up me-1"></i>8% this week
            </span>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6">
        <div class="stat-card bg-success bg-opacity-10 rounded-4 p-4 h-100">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-success text-white rounded-circle p-3 me-3">
              <i class="bi bi-people fs-4"></i>
            </div>
            <div>
              <h6 class="text-muted mb-1">Total Users</h6>
              <h3 class="mb-0">{{getAssociationsByStatus('APPROVED').length}}</h3>
            </div>
          </div>
          <div class="mt-3">
            <span class="badge bg-success-subtle text-success">
              <i class="bi bi-arrow-up me-1"></i>5% this month
            </span>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6">
        <div class="stat-card bg-info bg-opacity-10 rounded-4 p-4 h-100">
            <div class="d-flex align-items-center">
            <div class="stat-icon bg-info text-white rounded-circle p-3 me-3">
              <i class="bi bi-envelope fs-4"></i>
            </div>
            <div>
              <h6 class="text-muted mb-1">Pending Requests</h6>
              <h3 class="mb-0">{{requests.length}}</h3>
            </div>
          </div>
          <div class="mt-3">
            <span class="badge bg-warning-subtle text-warning">
              <i class="bi bi-clock me-1"></i>Needs attention
            </span>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-xl-8">
        <!-- Associations Management -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-transparent border-0 pt-4 pb-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <div class="icon-circle bg-primary-subtle me-3">
                  <i class="bi bi-building text-primary"></i>
                </div>
                <div>
                  <h4 class="mb-0 fw-bold">Associations Management</h4>
                  <p class="text-muted mb-0">Manage and monitor associations</p>
                </div>
            </div>
            <div class="d-flex gap-2">
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0">
                  <i class="bi bi-search"></i>
                </span>
                <input type="text" 
                       class="form-control border-start-0" 
                       placeholder="Search associations..." 
                       [(ngModel)]="searchTerm" 
                       (keyup)="filterAssociations()">
              </div>
              <select class="form-select" [(ngModel)]="statusFilter" (change)="filterAssociations()">
                <option value="ALL">All Status</option>
                <option value="PENDING">Pending</option>
                <option value="APPROVED">Approved</option>
                <option value="REJECTED">Rejected</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card-body p-0">
          <!-- Loading State -->
          <div *ngIf="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading associations...</p>
          </div>

          <!-- No Results State -->
          <div *ngIf="!loading && filteredAssociations.length === 0" class="text-center py-5">
            <i class="bi bi-search display-4 text-muted"></i>
            <p class="mt-3 text-muted">No associations found</p>
          </div>

          <!-- Table -->
          <div class="table-responsive" *ngIf="!loading && filteredAssociations.length > 0">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light">
                <tr>
                  <th class="border-0">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" (change)="toggleSelectAll($event)">
                    </div>
                  </th>
                  <th class="border-0">Association</th>
                  <th class="border-0">Status</th>
                  <th class="border-0">Location</th>
                  <th class="border-0 text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let association of filteredAssociations" class="border-bottom">
                  <td>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" 
                             [checked]="selectedAssociations.includes(association.idAssociation)"
                             (change)="toggleAssociationSelection(association.idAssociation)">
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="avatar-sm me-2 position-relative">
                        <img [src]="getAssociationLogo(association)" 
                             [alt]="association.associationName"
                             class="rounded-circle"
                             onerror="this.src='assets/images/default-logo.jpg'">
                        <div *ngIf="logoLoadingStates[association.idAssociation]" 
                             class="logo-loading-spinner">
                          <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                          </div>
                        </div>
                      </div>
                      <div>
                        <h6 class="mb-0">{{association.associationName}}</h6>
                        <small class="text-muted">{{association.associationAddress}}</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="{
                      'bg-warning': association.status === 'PENDING',
                      'bg-success': association.status === 'APPROVED',
                      'bg-danger': association.status === 'REJECTED'
                    }">
                      <i class="bi" [ngClass]="{
                        'bi-clock': association.status === 'PENDING',
                        'bi-check-circle': association.status === 'APPROVED',
                        'bi-x-circle': association.status === 'REJECTED'
                      }"></i>
                      {{association.status}}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <i class="bi bi-geo-alt text-muted me-2"></i>
                      {{association.associationAddress}}
                    </div>
                  </td>
                  <td class="text-end">
                    <div class="btn-group">
                      <button class="btn btn-sm btn-soft-primary" 
                              [routerLink]="['/admin/associations', association.idAssociation]"
                              tooltip="View Details">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-soft-success" 
                              *ngIf="association.status === 'PENDING'" 
                              (click)="verifyAssociation(association.idAssociation)"
                                tooltip="Approve">
                        <i class="bi bi-check-lg"></i>
                      </button>
                      <button class="btn btn-sm btn-soft-danger" 
                                *ngIf="association.status === 'PENDING'" 
                              (click)="deleteAssociation(association.idAssociation)"
                                tooltip="Reject">
                          <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
      </div>
    </div>

          <div class="card-footer bg-transparent border-0 p-4">
          <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex gap-2">
                <button class="btn btn-soft-primary" (click)="exportAssociations()">
                  <i class="bi bi-download me-2"></i>Export Data
                      </button>
                <button class="btn btn-soft-success" (click)="refreshData()">
                  <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                      </button>
                <button class="btn btn-soft-info" (click)="openBulkEmailModal()">
                  <i class="bi bi-envelope me-2"></i>Bulk Email
                      </button>
                    </div>
              <div class="text-muted">
                Showing {{filteredAssociations.length}} of {{associations.length}} associations
          </div>
        </div>
          </div>
        </div>
      </div>

      <!-- Crisis Management Section -->
      <div class="col-xl-8">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-transparent border-0 pt-4 pb-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <div class="icon-circle bg-warning-subtle me-3">
                  <i class="bi bi-exclamation-triangle text-warning"></i>
                </div>
                <div>
                  <h4 class="mb-0 fw-bold">Crisis Management</h4>
                  <p class="text-muted mb-0">Monitor and manage active crises</p>
                </div>
              </div>
              <div class="d-flex gap-2">
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-search"></i>
                  </span>
                  <input type="text" 
                         class="form-control border-start-0" 
                         placeholder="Search crises..." 
                         [(ngModel)]="crisisSearchTerm" 
                         (keyup)="filterCrises()">
                </div>
              </div>
            </div>
          </div>

          <div class="card-body p-0">
            <!-- Loading State -->
            <div *ngIf="loading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-muted">Loading crises...</p>
            </div>

            <!-- No Results State -->
            <div *ngIf="!loading && filteredCrises.length === 0" class="text-center py-5">
              <i class="bi bi-exclamation-circle display-4 text-muted"></i>
              <p class="mt-3 text-muted">No crises found</p>
            </div>

            <!-- Table -->
            <div class="table-responsive" *ngIf="!loading && filteredCrises.length > 0">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="border-0">Description</th>
                    <th class="border-0">Location</th>
                    <th class="border-0">Category</th>
                    <th class="border-0">Severity</th>
                    <th class="border-0">Status</th>
                    <th class="border-0 text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let crisis of filteredCrises" class="border-bottom">
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="icon-circle bg-light me-2">
                          <i class="bi" [ngClass]="getCategoryIcon(crisis.categorie)"></i>
                        </div>
                        <div>
                          <h6 class="mb-0">{{crisis.description}}</h6>
                          <small class="text-muted">{{crisis.crisisDate | date}}</small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <i class="bi bi-geo-alt text-muted me-2"></i>
                        {{crisis.location}}
                      </div>
                    </td>
                    <td>
                      <span class="badge bg-info-subtle text-info">
                        {{crisis.categorie}}
                      </span>
                    </td>
                    <td>
                      <span class="badge" [ngClass]="getSeverityClass(crisis.severity)">
                        <i class="bi" [ngClass]="getSeverityIcon(crisis.severity)"></i>
                        {{crisis.severity}}
                      </span>
                    </td>
                    <td>
                      <span class="badge" [ngClass]="getStatusClass(crisis.status)">
                        <i class="bi" [ngClass]="getStatusIcon(crisis.status)"></i>
                        {{crisis.status}}
                      </span>
                    </td>
                    <td class="text-end">
                      <div class="btn-group">
                        <button class="btn btn-sm btn-soft-primary" 
                                (click)="viewDetails(crisis)"
                                tooltip="View Details">
                          <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-soft-warning" 
                                (click)="updateCrisis(crisis)"
                                tooltip="Edit">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-soft-success" 
                                (click)="updateStatus(crisis)"
                                tooltip="Update Status">
                          <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-soft-danger" 
                                (click)="deleteCrisis(crisis.idCrisis)"
                                tooltip="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-footer bg-transparent border-0 p-4">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex gap-2">
                <button class="btn btn-soft-primary" (click)="exportCrisesToCSV()">
                  <i class="bi bi-download me-2"></i>Export Data
                </button>
                <button class="btn btn-soft-success" (click)="loadCrises()">
                  <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                </button>
                <button class="btn btn-soft-warning" (click)="analyzeCrisis()" [disabled]="!selectedCrisis || isGeneratingPredictions">
                  <i class="bi bi-search me-2"></i>
                  <span *ngIf="!isGeneratingPredictions">Analyze Crisis</span>
                  <span *ngIf="isGeneratingPredictions">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Analyzing...
                  </span>
                </button>
              </div>
              <div class="text-muted">
                Showing {{filteredCrises.length}} of {{crises.length}} crises
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Requests Management Section -->
      <div class="col-xl-8">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-transparent border-0 pt-4 pb-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <div class="icon-circle bg-info-subtle me-3">
                  <i class="bi bi-envelope text-info"></i>
                </div>
                <div>
                  <h4 class="mb-0 fw-bold">Requests Management</h4>
                  <p class="text-muted mb-0">Manage and monitor user requests</p>
                </div>
              </div>
              <div class="d-flex gap-2">
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-search"></i>
                  </span>
                  <input type="text" 
                         class="form-control border-start-0" 
                         placeholder="Search requests..." 
                         [(ngModel)]="searchRequestTerm" 
                         (keyup)="filterRequests()">
                </div>
              </div>
            </div>
          </div>

          <div class="card-body p-0">
            <!-- Loading State -->
            <div *ngIf="loading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-muted">Loading requests...</p>
            </div>

            <!-- No Results State -->
            <div *ngIf="!loading && filteredRequests.length === 0" class="text-center py-5">
              <i class="bi bi-inbox display-4 text-muted"></i>
              <p class="mt-3 text-muted">No requests found</p>
            </div>

            <!-- Table -->
            <div class="table-responsive" *ngIf="!loading && filteredRequests.length > 0">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="border-0">Subject</th>
                    <th class="border-0">Content</th>
                    <th class="border-0">Date</th>
                    <th class="border-0">Status</th>
                    <th class="border-0 text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let request of filteredRequests" class="border-bottom">
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="icon-circle bg-primary-subtle me-2">
                          <i class="bi bi-envelope text-primary"></i>
                        </div>
                        <div>
                          <h6 class="mb-0">{{request.object}}</h6>
                          <small class="text-muted">From: {{request.user?.firstName || 'Anonymous'}} {{request.user?.lastName || ''}}</small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <p class="mb-0 text-truncate" style="max-width: 200px;">{{request.content}}</p>
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <i class="bi bi-calendar text-muted me-2"></i>
                        {{request.createdAt || request.dateRequest | date:'short'}}
                      </div>
                    </td>
                    <td>
                      <span class="badge" [ngClass]="{
                        'bg-warning': !request.response,
                        'bg-success': request.response
                      }">
                        <i class="bi" [ngClass]="{
                          'bi-clock': !request.response,
                          'bi-check-circle': request.response
                        }"></i>
                        {{request.response ? 'Responded' : 'Pending'}}
                      </span>
                    </td>
                    <td class="text-end">
                      <div class="btn-group">
                        <button class="btn btn-sm btn-soft-primary" 
                                (click)="viewRequestDetails(request)"
                                tooltip="View Details">
                          <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-soft-success" 
                                *ngIf="!request.response"
                                (click)="respondToRequest(request)"
                                tooltip="Respond">
                          <i class="bi bi-reply"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-footer bg-transparent border-0 p-4">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted">
                Showing {{filteredRequests.length}} of {{requests.length}} requests
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="col-xl-4">
        <!-- Recent Activity -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-transparent border-0 pt-4 pb-3 px-4">
            <div class="d-flex align-items-center">
              <div class="icon-circle bg-primary-subtle me-3">
                <i class="bi bi-activity text-primary"></i>
              </div>
              <div>
                <h4 class="mb-0 fw-bold">Recent Activity</h4>
                <p class="text-muted mb-0">Latest updates and changes</p>
              </div>
            </div>
          </div>
          <div class="card-body p-4">
            <div class="activity-feed">
              <div *ngIf="recentActivities.length === 0" class="text-center text-muted py-3">
                <i class="bi bi-inbox fs-4"></i>
                <p class="mt-2">No recent activities</p>
              </div>
              <div *ngFor="let activity of recentActivities" class="activity-item">
                <div class="activity-icon" [ngClass]="getActivityColor(activity)">
                  <i class="bi" [ngClass]="getActivityIcon(activity)"></i>
                </div>
                <div class="activity-content">
                  <p class="mb-1">{{ activity.description }}</p>
                  <small class="text-muted">{{ formatActivityTime(activity.timestamp) }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-header bg-transparent border-0 pt-4 pb-3 px-4">
            <div class="d-flex align-items-center">
              <div class="icon-circle bg-primary-subtle me-3">
                <i class="bi bi-lightning text-primary"></i>
              </div>
              <div>
                <h4 class="mb-0 fw-bold">Quick Actions</h4>
                <p class="text-muted mb-0">Common tasks and operations</p>
              </div>
            </div>
          </div>
          <div class="card-body p-4">
            <div class="d-grid gap-2">
              <button class="btn btn-soft-primary d-flex align-items-center justify-content-between">
                <span>
                  <i class="bi bi-plus-circle me-2"></i>
                  Add New Association
                </span>
                <i class="bi bi-arrow-right"></i>
              </button>
              <button class="btn btn-soft-warning d-flex align-items-center justify-content-between">
                <span>
                  <i class="bi bi-exclamation-circle me-2"></i>
                  Report Crisis
                </span>
                <i class="bi bi-arrow-right"></i>
              </button>
              <button class="btn btn-soft-info d-flex align-items-center justify-content-between">
                <span>
                  <i class="bi bi-envelope me-2"></i>
                  Send Bulk Email
                </span>
                <i class="bi bi-arrow-right"></i>
              </button>
              <button class="btn btn-soft-success d-flex align-items-center justify-content-between">
                <span>
                  <i class="bi bi-file-earmark-text me-2"></i>
                  Generate Report
                </span>
                <i class="bi bi-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Email Modal -->
<ng-template #emailModal>
  <div class="modal-header">
    <h5 class="modal-title">Send Email</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="emailForm" (ngSubmit)="sendEmail()">
      <div class="mb-3">
        <label class="form-label">To</label>
        <input type="email" class="form-control" formControlName="to">
      </div>
      <div class="mb-3">
        <label class="form-label">Subject</label>
        <input type="text" class="form-control" formControlName="subject">
      </div>
      <div class="mb-3">
        <label class="form-label">Message</label>
        <textarea class="form-control" rows="5" formControlName="message"></textarea>
      </div>
      <div class="text-end">
        <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Send Email</button>
      </div>
    </form>
  </div>
</ng-template>

<!-- Bulk Email Modal -->
<ng-template #bulkEmailModal>
  <div class="modal-header">
    <h5 class="modal-title">Send Bulk Email</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="bulkEmailForm" (ngSubmit)="sendBulkEmail()">
      <div class="mb-3">
        <label class="form-label">Template</label>
        <select class="form-select" [(ngModel)]="selectedTemplate" (change)="applyTemplate()">
          <option value="">Select a template</option>
          <option value="welcome">Welcome Email</option>
          <option value="reminder">Reminder Email</option>
          <option value="notification">Notification Email</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Subject</label>
        <input type="text" class="form-control" formControlName="subject">
      </div>
      <div class="mb-3">
        <label class="form-label">Message</label>
        <textarea class="form-control" rows="5" formControlName="message"></textarea>
      </div>
      <div class="text-end">
        <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Send Bulk Email</button>
      </div>
    </form>
  </div>
</ng-template>

<!-- Crisis Details Modal -->
<ng-template #crisisDetailsModal>
  <div class="modal-header border-0">
    <h5 class="modal-title">Crisis Details</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <div *ngIf="selectedCrisis" class="crisis-details">
      <!-- Header Section -->
      <div class="d-flex align-items-center mb-4">
        <div class="icon-circle bg-warning-subtle me-3">
          <i class="bi" [ngClass]="getCategoryIcon(selectedCrisis.categorie)"></i>
        </div>
        <div>
          <h4 class="mb-1">{{selectedCrisis.description}}</h4>
          <div class="d-flex gap-2">
            <span class="badge" [ngClass]="getSeverityClass(selectedCrisis.severity)">
              <i class="bi" [ngClass]="getSeverityIcon(selectedCrisis.severity)"></i>
              {{selectedCrisis.severity}}
            </span>
            <span class="badge" [ngClass]="getStatusClass(selectedCrisis.status)">
              <i class="bi" [ngClass]="getStatusIcon(selectedCrisis.status)"></i>
              {{selectedCrisis.status}}
            </span>
          </div>
        </div>
      </div>

      <!-- Details Grid -->
      <div class="row g-4 mb-4">
        <div class="col-md-6">
          <div class="detail-card bg-light rounded-4 p-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-geo-alt text-primary me-2"></i>
              <h6 class="mb-0">Location</h6>
            </div>
            <p class="mb-0">{{selectedCrisis.location}}</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-card bg-light rounded-4 p-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-calendar-event text-primary me-2"></i>
              <h6 class="mb-0">Date Reported</h6>
            </div>
            <p class="mb-0">{{selectedCrisis.crisisDate | date:'medium'}}</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-card bg-light rounded-4 p-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-tag text-primary me-2"></i>
              <h6 class="mb-0">Category</h6>
            </div>
            <p class="mb-0">{{selectedCrisis.categorie}}</p>
          </div>
        </div>
      </div>

      <!-- Description Section -->
      <div class="mb-4">
        <h6 class="mb-3">Description</h6>
        <div class="bg-light rounded-4 p-3">
          <p class="mb-0">{{selectedCrisis.description}}</p>
        </div>
      </div>

      <!-- AI Analysis Section -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">AI Analysis</h6>
          <button class="btn btn-soft-primary" (click)="analyzeCrisis()" [disabled]="isGeneratingPredictions">
            <i class="bi bi-robot me-2"></i>
            <span *ngIf="!isGeneratingPredictions">Run AI Analysis</span>
            <span *ngIf="isGeneratingPredictions">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Analyzing...
            </span>
          </button>
        </div>

        <!-- Analysis Results -->
        <div *ngIf="urgencyAnalysis" class="analysis-results">
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <div class="analysis-card bg-light rounded-4 p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">Risk Score</span>
                  <span class="badge" [ngClass]="{
                    'bg-danger': urgencyAnalysis?.risk_score > 70,
                    'bg-warning': urgencyAnalysis?.risk_score > 30 && urgencyAnalysis?.risk_score <= 70,
                    'bg-success': urgencyAnalysis?.risk_score <= 30
                  }">{{urgencyAnalysis?.risk_score || 0}}%</span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="analysis-card bg-light rounded-4 p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">Crisis Status</span>
                  <span class="badge" [ngClass]="{
                    'bg-danger': urgencyAnalysis?.crisis_status === 'HIGH',
                    'bg-warning': urgencyAnalysis?.crisis_status === 'MEDIUM',
                    'bg-info': urgencyAnalysis?.crisis_status === 'LOW'
                  }">{{urgencyAnalysis?.crisis_status || 'N/A'}}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Resource Allocation -->
          <div *ngIf="resourceAllocation" class="mb-4">
            <h6 class="mb-3">Resource Allocation</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Location</th>
                    <th>Resources</th>
                    <th>Priority</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let allocation of resourceAllocation">
                    <td>{{allocation.location}}</td>
                    <td>{{allocation.resources}}</td>
                    <td>
                      <span class="badge" [ngClass]="{
                        'bg-danger': allocation.priority === 'HIGH',
                        'bg-warning': allocation.priority === 'MEDIUM',
                        'bg-info': allocation.priority === 'LOW'
                      }">{{allocation.priority}}</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Forecast Results -->
          <div *ngIf="forecast" class="mb-4">
            <h6 class="mb-3">Resource Forecast</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Predicted</th>
                    <th>Range</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of forecast">
                    <td>{{item.date | date}}</td>
                    <td>{{item.predicted}}</td>
                    <td>{{item.lower}} - {{item.upper}}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Error Message -->
        <div class="alert alert-danger mt-3" *ngIf="predictionError">
          {{predictionError}}
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer border-0">
    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
  </div>
</ng-template>

<style>
.timeline {
  position: relative;
  padding-left: 20px;
}

.timeline-item {
  position: relative;
  padding-bottom: 20px;
}

.timeline-item:before {
  content: '';
  position: absolute;
  left: -20px;
  top: 0;
  width: 2px;
  height: 100%;
  background-color: #e9ecef;
}

.timeline-item:last-child:before {
  height: 0;
}

.timeline-header {
  margin-bottom: 10px;
}

.timeline-body {
  background-color: #f8f9fa;
  padding: 15px;
  border-radius: 4px;
}

.supply-point {
  background-color: #f8f9fa;
  padding: 15px;
  border-radius: 4px;
  margin-bottom: 10px;
}

.supply-point:last-child {
  margin-bottom: 0;
}

/* Enhanced styles for Association Management */
.avatar-sm {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

.avatar-sm img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.avatar-sm:hover img {
  transform: scale(1.1);
}

.logo-loading-spinner {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.badge {
  padding: 0.5em 0.75em;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.badge i {
  font-size: 0.875rem;
}

.btn-soft-primary,
.btn-soft-success,
.btn-soft-info {
  transition: all 0.3s ease;
  border: 1px solid transparent;
}

.btn-soft-primary:hover,
.btn-soft-success:hover,
.btn-soft-info:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.table > :not(caption) > * > * {
  padding: 1rem;
  vertical-align: middle;
}

.table tbody tr {
  transition: background-color 0.3s ease;
}

.table tbody tr:hover {
  background-color: rgba(0, 0, 0, 0.02);
}

[tooltip] {
  position: relative;
}

[tooltip]:hover:before {
  content: attr(tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  padding: 0.5rem 0.75rem;
  background-color: rgba(0, 0, 0, 0.8);
  color: white;
  font-size: 0.75rem;
  border-radius: 0.25rem;
  white-space: nowrap;
  z-index: 1000;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.spinner-border {
  width: 2rem;
  height: 2rem;
}

.spinner-border-sm {
  width: 1rem;
  height: 1rem;
}

/* Enhanced styles for Association Management */
.stat-card {
  transition: transform 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-5px);
}

.stat-icon {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.stat-icon i {
  font-size: 1.25rem;
}

.form-check-input {
  cursor: pointer;
}

.form-check-input:checked {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

.btn-soft-danger {
  color: #dc3545;
  background-color: rgba(220, 53, 69, 0.1);
  border-color: transparent;
}

.btn-soft-danger:hover {
  color: #fff;
  background-color: #dc3545;
  transform: translateY(-1px);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.selected-associations-list {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  padding: 0.5rem;
}

.selected-association-item {
  padding: 0.5rem;
  border-bottom: 1px solid #dee2e6;
}

.selected-association-item:last-child {
  border-bottom: none;
}

.preview-card {
  border: 1px solid #dee2e6;
  background-color: #f8f9fa;
}

.preview-header {
  border-bottom: 1px solid #dee2e6;
  padding-bottom: 0.5rem;
}

.preview-content {
  white-space: pre-wrap;
}
</style>

